package com.spring.webservice.utill;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.Statement;

import org.apache.ibatis.session.SqlSession;
import org.springframework.beans.factory.annotation.Autowired;
import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

public class TelegramBot extends TelegramLongPollingBot {
	
   	@Autowired
	private SqlSession sqlSession;
   	
    private final String BOT_NAME = "Kim_Scheduler_Bot"; //Bot Name
    private final String AUTH_KEY = "1334891991:AAGkrXOd3oPP92tQzRclNY4nmxwuvMPIUqM"; //Bot Auth-Key
    private final String CHAT_ID = "616043197";
    //private final String CHAT_ID = "-381510796"; //Chat ID
    
    @Override 
   public void onUpdateReceived(Update update) {
    	
        // TODO
    	System.out.println(update);
    	System.out.println(update.getMessage().getText());
    	
    	String Text = update.getMessage().getText();
    	
    	
    	/* DB Connection */
    	String sqlHost = "jdbc:mysql://localhost:3306/webservice?useSSL=false&characterEncoding=UTF-8&serverTimezone=UTC";
    	String user = "root";
    	String pw = "root";
    	
    	try {
          String myDriver = "com.mysql.cj.jdbc.Driver";
          Class.forName(myDriver);
          Connection conn = DriverManager.getConnection(sqlHost, user, pw);
          
          // our SQL SELECT query. 
          // if you only need a few columns, specify them by name instead of using "*"
          String query = "SELECT * FROM MEMO";

          // create the java statement
          Statement st = conn.createStatement();
          
          // execute the query, and get a java resultset
          ResultSet rs = st.executeQuery(query);
          
          // iterate through the java resultset
          while (rs.next())
          {
            String firstName = rs.getString("CONTENT");
            String lastName = rs.getString("ID");
            
            // print the results
            System.out.format(firstName, lastName);
          }
          st.close();
        }
        catch (Exception e)
        {
          System.err.println("Got an exception! ");
          System.err.println(e.getMessage());
        }
    	
    	
    	SendMessage message = new SendMessage();
    	//add chat id and text
    	message.setChatId(CHAT_ID);
    	message.setText("けけけけけ\nAaaaa");
		
		try {
			execute(message);
		} catch (TelegramApiException e) {
			e.printStackTrace();
		}
		
    	/*
    	 * SendMessage message = new SendMessage().enableHtml(true);
		message.setText("AAA");
		message.setChatId("aa");
		
		try {
			execute(message);
		} catch (TelegramApiException e) {
			e.printStackTrace();
		}
    	 */
   }

   @Override 
   public String getBotUsername() {
        // TODO 
       return BOT_NAME;
   }

   @Override 
   public String getBotToken() {
        // TODO 
       return  AUTH_KEY;
   }
}
